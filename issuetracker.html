<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SORMAS Issuetracker</title>
</head>
<body>
    <h1>SORMAS Issuetracker Alpha</h1>
    <div id="errors"></div>
    <div>
        <h4 style="color: red">Please note: current fetch limit is 100 entries, including PRs!</h4>
        <h4>Target Repository: (e.g. ImisDevelopers/1_011_a_infektionsfall_uebermittellung) </h4>
        <input type="text" id="targetrepo" name="targetrepo" value="ImisDevelopers/1_011_a_infektionsfall_uebermittellung" style="width: 30%"><br>
        <h4>Target Tags: (e.g. state=open&labels=issuetracker)</h4>
        <input type="text" id="targettags" name="targettags" value="per_page=100&state=open&labels=issuetracker" style="width: 30%"><br>
        <button onclick="submitTargetURL()">Fetch Data</button>
    </div>
    <div id="maincontents"></div>
</body>
</html>
<script>
    const http = new XMLHttpRequest()

    //http.open('GET', 'https://api.github.com/repos/hadley/dplyr/issues')
    //http.send()
    //http.onload = () => document.write(http.responseText)
    //http.onload = () =>  document.getElementById("demo").innerHTML = http.responseText;

    function formatDescription(desc) {
        // Replace all headlines
        desc = desc.replace(new RegExp('####.*', 'g'), function (x) {
            return '<h4>' + x.substring(3, x.length) + '</h4>'
        })
        desc = desc.replace(new RegExp('###.*', 'g'), function (x) {
            return '<h3>' + x.substring(3, x.length) + '</h3>'
        })
        desc = desc.replace(new RegExp('##.*', 'g'), function (x) {
            return '<h2>' + x.substring(3, x.length) + '</h2>'
        })

        // code
        desc = desc.replace(new RegExp('`.*`', 'g'), function (x) {
            return '<code>' + x.substring(1, x.length - 1) + '</code>'
        })
        // fat, cursive
        desc = desc.replace(new RegExp('\\*\\*.*\\*\\*', 'g'), function (x) {
            return '<b>' + x.substring(2, x.length - 2) + '</b>'
        })
        desc = desc.replace(new RegExp('_.*_', 'g'), function (x) {
            return '<i>' + x.substring(1, x.length - 1) + '</i>'
        })
        // links
        desc = desc.replace(new RegExp('\\[.*\\]\\(.*\\)', 'g'), function (x) {
            return (
                '<a href="' +
                x.substring(x.search(']') + 2, x.length - 1) +
                '">' +
                x.substring(1, x.search(']')) +
                '</a>'
            )
        })
        // Replace Linebreaks
        desc = desc.replace(new RegExp('\r?\n', 'g'), '<br>')

        return desc
    }

    class Feature {
        title = ''
        progressbar = ''
        mainbody = ''
        linksection = ''

        constructor(issue) {
            this.issue = issue
        }
        formatContents() {
            if (this.issue != null) {
                // Title
                this.title =
                    '<div><h2 style="display:inline;"><a href="' +
                    this.issue.url +
                    '">' +
                    this.issue.title +
                    '</a></h2>'
                if (this.issue.milestone != null) {
                    if(this.issue.milestone.due_on != null) {
                        this.title +=
                            '<p style="display:inline; margin-left: 5%">ETA: ' +
                            this.issue.milestone.due_on.substring(0, 10) +
                            ' (' +
                            this.issue.milestone.title +
                            ')</p>'
                    }
                    else
                    {
                        this.title +=
                            '<p style="display:inline; margin-left: 5%">ETA: ' +
                            this.issue.milestone.title +
                            '</p>'
                    }
                }
                this.title += '</div>';

                // Progressbar
                if(this.PR == null) {
                    this.progressbar = '<div class="progressbardiv"><span class="progressbarspan" style="width: 25%"></span><span class="progressbartext">Konzeptionierung</span></div>';
                }
                else if(this.PR != null)
                {
                    // check if PR has been closed
                    if(this.PR.merged_at == null)
                    {
                        if(this.PR.requested_reviewers.length == 0)
                        {
                            // No review requested
                            this.progressbar = '<div class="progressbardiv"><span class="progressbarspan" style="width: 50%"></span><span class="progressbartext">Entwicklung</span></div>';
                        }
                        else
                        {
                            // Review requested
                            this.progressbar = '<div class="progressbardiv"><span class="progressbarspan" style="width: 75%"></span><span class="progressbartext">Qualit&auml;tssicherung</span></div>';
                        }
                    }
                    else {
                        // Done
                        // maybe i should check if the issue is closed instead?
                        this.progressbar = '<div class="progressbardiv"><span class="progressbarspan" style="width: 100%"></span><span class="progressbartext">Fertig</span></div>';
                    }
                }
                // Body
                this.mainbody += '<h3>Beschreibung</h3>';
                if (this.issue.body.search('### Issuetracker Description') != -1) {
                    this.mainbody += formatDescription(
                        this.issue.body.substring(
                            this.issue.body.search('### Issuetracker Description') + 28,
                            this.issue.body.length
                        )
                    )
                } else {
                    this.mainbody += '<p>Keine Spezielle Beschreibung gefunden. Folgende Beschreibung wurde aus dem zugeh&ouml;rigen GitHub-Issue generiert.<p><div style="border: 1px dashed gray;">' + formatDescription(this.issue.body) + '</div>';
                }

                // Links
                this.linksection += '<h3>Links</h3>'
                this.linksection += '<a href="' + this.issue.html_url + '" target="_blank">GitHub Issue (#' + this.issue.number + ')</a><br>'
                if(this.PR != null)
                {
                    this.linksection += '<a href="' + this.PR.html_url + '" target="_blank">GitHub Pull Request (#' + this.PR.number + ')</a><br>'
                }
            }
        }
    }

    function styleCollapsibles()
    {
        const collapsibles = document.getElementsByClassName('collapsiblebtn')
        let i

        for(i = 0; i < collapsibles.length; i++)
        {
            collapsibles[i].addEventListener('click', function(){
                this.classList.toggle("active");
                const content = this.nextElementSibling;
                if(content != null)
                {
                    if (content.style.maxHeight){
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                }
            })
        }
    }

    function parseIssues(arr) {
        let out = ''
        let i
        const featurearray = []
        // create feature divs
        for (i = 0; i < arr.length; i++) {
            if (arr[i].pull_request == null) {
                featurearray.push(new Feature(arr[i]))
            }
        }
        // link PRs
        // this should be possible with less xmlhttp requests!
        // fetch all open PR's
        const url = 'https://api.github.com/repos/' + document.getElementById("targetrepo").value + '/pulls?state=open';
        const xmlhttp = new XMLHttpRequest()
        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                const PRarr = JSON.parse(this.responseText)
                let j;
                for(j = 0; j < PRarr.length; j++)
                {
                    // for each issue, check if its mentioned in PR
                    let k;
                    for(k = 0; k < featurearray.length; k++)
                    {
                        if (PRarr[j].body != null) {
                            // this is not yet ideal, as e.g. a PR mentioning #485 is linked to issue #485 and issue #48
                            if (
                                PRarr[j].body.search('#' + featurearray[k].issue.number) != -1 ||
                                PRarr[j].title.search('#' + featurearray[k].issue.number) != -1
                            ) {
                                featurearray[k].PR = PRarr[j]
                            }
                        }
                    }
                }
            }
            else if(this.readyState == 4 && this.status == 403)
            {
                console.log(this.responseText)
                console.log(this);
                document.getElementById("errors").innerHTML += '<p>' + this.responseText + '</p>';
            }
        }
        xmlhttp.open('GET', url, false)
        xmlhttp.send()

        for (i = 0; i < 0; i++) {
            if (arr[i].pull_request != null) {
                let j
                for (j = 0; j < featurearray.length; j++) {
                    if (arr[i].body != null) {
                        if (
                            arr[i].body.search('#' + featurearray[j].issue.number) != -1 ||
                            arr[i].title.search('#' + featurearray[j].issue.number) != -1
                        ) {
                            featurearray[j].prissue = arr[i]
                            // also attach PR itself
                            const xmlhttp2 = new XMLHttpRequest()
                            const url = arr[i].pull_request.url

                            xmlhttp2.onreadystatechange = function () {
                                if (this.readyState == 4 && this.status == 200) {
                                    const PR = JSON.parse(this.responseText)
                                    featurearray[j].PR = PR;

                                } else if (this.readyState == 4 && this.status == 404) {
                                    // something didn't work
                                    console.log('could not retrieve PR data from API')
                                }
                            }
                            xmlhttp2.open('GET', url, false)
                            xmlhttp2.send()
                        }
                    }
                }
            }
        }

        // format feature divs
        for (i = 0; i < featurearray.length; i++) {
            featurearray[i].formatContents()
            out += '<div class="feature"><button class="collapsiblebtn">' + featurearray[i].title + '<br>' + featurearray[i].progressbar +  '</button><div class="collapsiblecontent"><p>' + featurearray[i].mainbody + '</p><p>' + featurearray[i].linksection + '</p></div></div>'
        }

        document.getElementById('maincontents').innerHTML = out
        styleCollapsibles()
    }

    // Pagination is a Problem! I need to iterate over all pages for reliable results
    //const url = "https://api.github.com/repos/hzi-braunschweig/SORMAS-Project/issues?per_page=100&state=open";
    let url = 'https://api.github.com/repos/ImisDevelopers/1_011_a_infektionsfall_uebermittellung/issues?per_page=100&state=open&labels=issuetracker'
    function submitTargetURL()
    {
        url = 'https://api.github.com/repos/' + document.getElementById("targetrepo").value + '/issues?' + document.getElementById("targettags").value;
        const xmlhttp = new XMLHttpRequest()

        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                const myArr = JSON.parse(this.responseText)
                parseIssues(myArr)
            }
            else if(this.readyState == 4 && this.status == 403)
            {
                console.log(this.responseText)
                console.log(this);
                document.getElementById("errors").innerHTML += '<p>' + this.responseText + '</p>';
            }
        }
        xmlhttp.open('GET', url, true)
        xmlhttp.send()
    }

</script>
<style>
    body {
        font-family: "Ubuntu", Sans-serif;
        color: black;
    }

    .feature{
        border: 1px solid black;
        width: 40%;
        min-width: 500px;
    }

    .collapsiblebtn{
        background-color: #eee;
        color: black;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        text-align: left;
        font-size: 15px;
        box-shadow: none;
    }
    .active, .collapsiblebtn:hover {
        background-color: #005AA0;
    }
    .collapsiblecontent{
        padding: 0 18px;
        overflow: hidden;
        background-color: #f1f1f1;
        max-height: 0;
        transition: max-height 0.2s ease-out;
    }

    .progressbardiv {
        height: 20px;
        width: 20vw;
        position: relative;
        background: #555;
        border-radius: 1vw;
        padding: 5px;
    }

    .progressbartext {
        width: 100%;
        height: 100%;
        text-align: center;
        position: absolute;
    }

    .progressbarspan {
        display: block;
        height: 80%;
        border-radius: 0.8vw;
        background-color: #006dc2;
        position: absolute;
        top: 10%;
        overflow: hidden;
    }

</style>